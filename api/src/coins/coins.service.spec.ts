import { HttpModule, HttpService } from '@nestjs/axios';
import { ConfigModule } from '@nestjs/config';
import { Test, TestingModule } from '@nestjs/testing';
import { of } from 'rxjs';
import { CoinsService } from './coins.service';

describe('CoinsService', () => {
  let service: CoinsService;
  let httpService: HttpService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      imports: [HttpModule, ConfigModule],
      providers: [CoinsService],
    }).compile();

    httpService = module.get<HttpService>(HttpService);
    service = module.get<CoinsService>(CoinsService);
  });

  it('returns coins data', async () => {
    const apiData: Object = {"Message":"Success","Type":100,"MetaData":{"Count":728},"SponsoredData":[],"Data":[{"CoinInfo":{"Id":"1182","Name":"BTC","FullName":"Bitcoin","Internal":"BTC","ImageUrl":"/media/37746251/btc.png","Url":"/coins/btc/overview","Algorithm":"SHA-256","ProofType":"PoW","Rating":{"Weiss":{"Rating":"B+","TechnologyAdoptionRating":"A-","MarketPerformanceRating":"D"}},"NetHashesPerSecond":270359733543033240000,"BlockNumber":765314,"BlockTime":562,"BlockReward":6.25,"AssetLaunchDate":"2009-01-03","MaxSupply":20999999.9769,"Type":1,"DocumentType":"Webpagecoinp"},"RAW":{"USD":{"TYPE":"5","MARKET":"CCCAGG","FROMSYMBOL":"BTC","TOSYMBOL":"USD","FLAGS":"2049","PRICE":16874.86,"LASTUPDATE":1669810325,"MEDIAN":16879,"LASTVOLUME":0.00006505,"LASTVOLUMETO":1.09875955,"LASTTRADEID":"1260473508","VOLUMEDAY":36581.47243283459,"VOLUMEDAYTO":616517231.1553353,"VOLUME24HOUR":61644.18969569,"VOLUME24HOURTO":1027964589.1792141,"OPENDAY":16431.81,"HIGHDAY":17068.26,"LOWDAY":16424.76,"OPEN24HOUR":16467.32,"HIGH24HOUR":17042.5,"LOW24HOUR":16320.14,"LASTMARKET":"Bitfinex","VOLUMEHOUR":215.29089211000084,"VOLUMEHOURTO":3632561.0670165177,"OPENHOUR":16874.06,"HIGHHOUR":16879.9,"LOWHOUR":16868.42,"TOPTIERVOLUME24HOUR":61644.18969569,"TOPTIERVOLUME24HOURTO":1027964589.1792141,"CHANGE24HOUR":407.5400000000009,"CHANGEPCT24HOUR":2.4748410791798596,"CHANGEDAY":443.0499999999993,"CHANGEPCTDAY":2.69629456523657,"CHANGEHOUR":0.7999999999992724,"CHANGEPCTHOUR":0.004741004832264863,"CONVERSIONTYPE":"direct","CONVERSIONSYMBOL":"","SUPPLY":19220718,"MKTCAP":324346925349.48004,"MKTCAPPENALTY":0,"CIRCULATINGSUPPLY":19220718,"CIRCULATINGSUPPLYMKTCAP":324346925349.48004,"TOTALVOLUME24H":545001.5939797873,"TOTALVOLUME24HTO":9184553116.436756,"TOTALTOPTIERVOLUME24H":544590.5181513124,"TOTALTOPTIERVOLUME24HTO":9177616269.381859,"IMAGEURL":"/media/37746251/btc.png"}},"DISPLAY":{"USD":{"FROMSYMBOL":"Ƀ","TOSYMBOL":"$","MARKET":"CryptoCompare Index","PRICE":"$ 16,874.9","LASTUPDATE":"Just now","LASTVOLUME":"Ƀ 0.00006505","LASTVOLUMETO":"$ 1.10","LASTTRADEID":"1260473508","VOLUMEDAY":"Ƀ 36,581.5","VOLUMEDAYTO":"$ 616,517,231.2","VOLUME24HOUR":"Ƀ 61,644.2","VOLUME24HOURTO":"$ 1,027,964,589.2","OPENDAY":"$ 16,431.8","HIGHDAY":"$ 17,068.3","LOWDAY":"$ 16,424.8","OPEN24HOUR":"$ 16,467.3","HIGH24HOUR":"$ 17,042.5","LOW24HOUR":"$ 16,320.1","LASTMARKET":"Bitfinex","VOLUMEHOUR":"Ƀ 215.29","VOLUMEHOURTO":"$ 3,632,561.1","OPENHOUR":"$ 16,874.1","HIGHHOUR":"$ 16,879.9","LOWHOUR":"$ 16,868.4","TOPTIERVOLUME24HOUR":"Ƀ 61,644.2","TOPTIERVOLUME24HOURTO":"$ 1,027,964,589.2","CHANGE24HOUR":"$ 407.54","CHANGEPCT24HOUR":"2.47","CHANGEDAY":"$ 443.05","CHANGEPCTDAY":"2.70","CHANGEHOUR":"$ 0.80","CHANGEPCTHOUR":"0.00","CONVERSIONTYPE":"direct","CONVERSIONSYMBOL":"","SUPPLY":"Ƀ 19,220,718.0","MKTCAP":"$ 324.35 B","MKTCAPPENALTY":"0 %","CIRCULATINGSUPPLY":"Ƀ 19,220,718.0","CIRCULATINGSUPPLYMKTCAP":"$ 324.35 B","TOTALVOLUME24H":"Ƀ 545.00 K","TOTALVOLUME24HTO":"$ 9.18 B","TOTALTOPTIERVOLUME24H":"Ƀ 544.59 K","TOTALTOPTIERVOLUME24HTO":"$ 9.18 B","IMAGEURL":"/media/37746251/btc.png"}}},{"CoinInfo":{"Id":"7605","Name":"ETH","FullName":"Ethereum","Internal":"ETH","ImageUrl":"/media/37746238/eth.png","Url":"/coins/eth/overview","Algorithm":"Ethash","ProofType":"PoS","Rating":{"Weiss":{"Rating":"B-","TechnologyAdoptionRating":"B","MarketPerformanceRating":"D"}},"NetHashesPerSecond":0,"BlockNumber":16082689,"BlockTime":12.075471698113207,"BlockReward":0.22330473823529365,"AssetLaunchDate":"2015-07-30","MaxSupply":-1,"Type":1,"DocumentType":"Webpagecoinp"},"RAW":{"USD":{"TYPE":"5","MARKET":"CCCAGG","FROMSYMBOL":"ETH","TOSYMBOL":"USD","FLAGS":"2052","PRICE":1267.76,"LASTUPDATE":1669810322,"MEDIAN":1267.7,"LASTVOLUME":3.18701183,"LASTVOLUMETO":4041.3540912681,"LASTTRADEID":"391869420","VOLUMEDAY":283864.479753787,"VOLUMEDAYTO":359366306.6847656,"VOLUME24HOUR":494256.76073852007,"VOLUME24HOURTO":614775485.4085034,"OPENDAY":1215.7,"HIGHDAY":1281.52,"LOWDAY":1212.49,"OPEN24HOUR":1215.33,"HIGH24HOUR":1281.44,"LOW24HOUR":1202.17,"LASTMARKET":"Coinbase","VOLUMEHOUR":1961.2283576400011,"VOLUMEHOURTO":2484858.6417005635,"OPENHOUR":1266.42,"HIGHHOUR":1267.89,"LOWHOUR":1265.88,"TOPTIERVOLUME24HOUR":494256.76073852007,"TOPTIERVOLUME24HOURTO":614775485.4085034,"CHANGE24HOUR":52.430000000000064,"CHANGEPCT24HOUR":4.314054618910096,"CHANGEDAY":52.059999999999945,"CHANGEPCTDAY":4.28230649008801,"CHANGEHOUR":1.3399999999999181,"CHANGEPCTHOUR":0.10581007880481341,"CONVERSIONTYPE":"direct","CONVERSIONSYMBOL":"","SUPPLY":122373866.2178,"MKTCAP":155140692636.27814,"MKTCAPPENALTY":0,"CIRCULATINGSUPPLY":122373866.2178,"CIRCULATINGSUPPLYMKTCAP":155140692636.27814,"TOTALVOLUME24H":3347638.3755339156,"TOTALVOLUME24HTO":4232178561.381514,"TOTALTOPTIERVOLUME24H":3340611.0437429347,"TOTALTOPTIERVOLUME24HTO":4223269591.2301803,"IMAGEURL":"/media/37746238/eth.png"}},"DISPLAY":{"USD":{"FROMSYMBOL":"Ξ","TOSYMBOL":"$","MARKET":"CryptoCompare Index","PRICE":"$ 1,267.76","LASTUPDATE":"Just now","LASTVOLUME":"Ξ 3.19","LASTVOLUMETO":"$ 4,041.35","LASTTRADEID":"391869420","VOLUMEDAY":"Ξ 283,864.5","VOLUMEDAYTO":"$ 359,366,306.7","VOLUME24HOUR":"Ξ 494,256.8","VOLUME24HOURTO":"$ 614,775,485.4","OPENDAY":"$ 1,215.70","HIGHDAY":"$ 1,281.52","LOWDAY":"$ 1,212.49","OPEN24HOUR":"$ 1,215.33","HIGH24HOUR":"$ 1,281.44","LOW24HOUR":"$ 1,202.17","LASTMARKET":"Coinbase","VOLUMEHOUR":"Ξ 1,961.23","VOLUMEHOURTO":"$ 2,484,858.6","OPENHOUR":"$ 1,266.42","HIGHHOUR":"$ 1,267.89","LOWHOUR":"$ 1,265.88","TOPTIERVOLUME24HOUR":"Ξ 494,256.8","TOPTIERVOLUME24HOURTO":"$ 614,775,485.4","CHANGE24HOUR":"$ 52.43","CHANGEPCT24HOUR":"4.31","CHANGEDAY":"$ 52.06","CHANGEPCTDAY":"4.28","CHANGEHOUR":"$ 1.34","CHANGEPCTHOUR":"0.11","CONVERSIONTYPE":"direct","CONVERSIONSYMBOL":"","SUPPLY":"Ξ 122,373,866.2","MKTCAP":"$ 155.14 B","MKTCAPPENALTY":"0 %","CIRCULATINGSUPPLY":"Ξ 122,373,866.2","CIRCULATINGSUPPLYMKTCAP":"$ 155.14 B","TOTALVOLUME24H":"Ξ 3.35 M","TOTALVOLUME24HTO":"$ 4.23 B","TOTALTOPTIERVOLUME24H":"Ξ 3.34 M","TOTALTOPTIERVOLUME24HTO":"$ 4.22 B","IMAGEURL":"/media/37746238/eth.png"}}},{"CoinInfo":{"Id":"171986","Name":"USDT","FullName":"Tether","Internal":"USDT","ImageUrl":"/media/37746338/usdt.png","Url":"/coins/usdt/overview","Algorithm":"N/A","ProofType":"N/A","Rating":{"Weiss":{"Rating":"","TechnologyAdoptionRating":"","MarketPerformanceRating":""}},"NetHashesPerSecond":0,"BlockNumber":0,"BlockTime":0,"BlockReward":0,"AssetLaunchDate":"2014-10-06","MaxSupply":-1,"Type":1,"DocumentType":"Webpagecoinp"},"RAW":{"USD":{"TYPE":"5","MARKET":"CCCAGG","FROMSYMBOL":"USDT","TOSYMBOL":"USD","FLAGS":"2052","PRICE":0.9999,"LASTUPDATE":1669810315,"MEDIAN":0.99979,"LASTVOLUME":0.12,"LASTVOLUMETO":0.1199916,"LASTTRADEID":"30618390","VOLUMEDAY":87861295.49512243,"VOLUMEDAYTO":87856538.7833859,"VOLUME24HOUR":234594114.15145677,"VOLUME24HOURTO":234532928.73119158,"OPENDAY":0.9997,"HIGHDAY":1,"LOWDAY":0.9995,"OPEN24HOUR":0.9997,"HIGH24HOUR":1,"LOW24HOUR":0.9994,"LASTMARKET":"Coinbase","VOLUMEHOUR":1002928.7382314192,"VOLUMEHOURTO":1002752.6506803818,"OPENHOUR":0.9999,"HIGHHOUR":1,"LOWHOUR":0.9999,"TOPTIERVOLUME24HOUR":234594114.15145677,"TOPTIERVOLUME24HOURTO":234532928.73119158,"CHANGE24HOUR":0.00019999999999997797,"CHANGEPCT24HOUR":0.020006001800537958,"CHANGEDAY":0.00019999999999997797,"CHANGEPCTDAY":0.020006001800537958,"CHANGEHOUR":0,"CHANGEPCTHOUR":0,"CONVERSIONTYPE":"direct","CONVERSIONSYMBOL":"","SUPPLY":65362681003.31587,"MKTCAP":65356144735.21554,"MKTCAPPENALTY":0,"CIRCULATINGSUPPLY":65362681003.31587,"CIRCULATINGSUPPLYMKTCAP":65356144735.21554,"TOTALVOLUME24H":523377605.43109703,"TOTALVOLUME24HTO":523287541.6617039,"TOTALTOPTIERVOLUME24H":511380028.64144295,"TOTALTOPTIERVOLUME24HTO":511291164.62972873,"IMAGEURL":"/media/37746338/usdt.png"}},"DISPLAY":{"USD":{"FROMSYMBOL":"₮","TOSYMBOL":"$","MARKET":"CryptoCompare Index","PRICE":"$ 0.9999","LASTUPDATE":"Just now","LASTVOLUME":"₮ 0.1200","LASTVOLUMETO":"$ 0.1200","LASTTRADEID":"30618390","VOLUMEDAY":"₮ 87,861,295.5","VOLUMEDAYTO":"$ 87,856,538.8","VOLUME24HOUR":"₮ 234,594,114.2","VOLUME24HOURTO":"$ 234,532,928.7","OPENDAY":"$ 0.9997","HIGHDAY":"$ 1.00","LOWDAY":"$ 0.9995","OPEN24HOUR":"$ 0.9997","HIGH24HOUR":"$ 1.00","LOW24HOUR":"$ 0.9994","LASTMARKET":"Coinbase","VOLUMEHOUR":"₮ 1,002,928.7","VOLUMEHOURTO":"$ 1,002,752.7","OPENHOUR":"$ 0.9999","HIGHHOUR":"$ 1.00","LOWHOUR":"$ 0.9999","TOPTIERVOLUME24HOUR":"₮ 234,594,114.2","TOPTIERVOLUME24HOURTO":"$ 234,532,928.7","CHANGE24HOUR":"$ 0.00020","CHANGEPCT24HOUR":"0.02","CHANGEDAY":"$ 0.00020","CHANGEPCTDAY":"0.02","CHANGEHOUR":"$ 0.0","CHANGEPCTHOUR":"0.00","CONVERSIONTYPE":"direct","CONVERSIONSYMBOL":"","SUPPLY":"₮ 65,362,681,003.3","MKTCAP":"$ 65.36 B","MKTCAPPENALTY":"0 %","CIRCULATINGSUPPLY":"₮ 65,362,681,003.3","CIRCULATINGSUPPLYMKTCAP":"$ 65.36 B","TOTALVOLUME24H":"₮ 523.38 M","TOTALVOLUME24HTO":"$ 523.29 M","TOTALTOPTIERVOLUME24H":"₮ 511.38 M","TOTALTOPTIERVOLUME24HTO":"$ 511.29 M","IMAGEURL":"/media/37746338/usdt.png"}}}],"RateLimit":{},"HasWarning":false}
    
    const fakeResponse = {
      status: 200,
      statusText: 'OK',
      headers: {},
      config: {},
      data: apiData,
    };

    jest.spyOn(httpService, 'get').mockImplementation(() => of(fakeResponse));
    let response = await service.getCoins();
    const expectedResult = [{"dc": "2.47", "imageURL": "/media/37746251/btc.png", "mc": 324.35, "name": "BTC", "price": 16874.9, "volume": 1027.96}, {"dc": "4.31", "imageURL": "/media/37746238/eth.png", "mc": 155.14, "name": "ETH", "price": 1267.76, "volume": 614.78}, {"dc": "0.02", "imageURL": "/media/37746338/usdt.png", "mc": 65.36, "name": "USDT", "price": 0.9999, "volume": 234.53}]
    expect(response).toEqual(expectedResult);
    expect(httpService.get).toHaveBeenCalledWith(
      "https://min-api.cryptocompare.com/data/top/mktcapfull",  {
         "params": {
            "apiKey": undefined,
            "limit": 30,
            "tsym": "USD",
          },
      }
    );
  });
});

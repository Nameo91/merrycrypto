import { HttpModule, HttpService } from '@nestjs/axios';
import { ConfigModule } from '@nestjs/config';
import { Test, TestingModule } from '@nestjs/testing';
import { of } from 'rxjs';
import { GlobalService } from './global.service';

describe('GlobalService', () => {
  let service: GlobalService;
  let httpService: HttpService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      imports: [HttpModule, ConfigModule],
      providers: [GlobalService],
    }).compile();

    httpService = module.get<HttpService>(HttpService);
    service = module.get<GlobalService>(GlobalService);
  });

  it('returns global market data', async () => {
    const fakeResponse = {
      status: 200,
      statusText: 'OK',
      headers: {},
      config: {},
      data: {"data":{"active_cryptocurrencies":13148,"upcoming_icos":0,"ongoing_icos":49,"ended_icos":3376,"markets":610,"total_market_cap":{"btc":52659478.00670086,"eth":701170669.1307473,"ltc":11383276399.240011,"bch":7916661762.409688,"bnb":2956187495.3148093,"eos":944493617570.8564,"xrp":2205615423922.5806,"xlm":9922164971336.168,"link":119505456124.81676,"dot":164231823945.81186,"yfi":133587099.93059172,"usd":891700764656.8683,"aed":3275203533073.206,"ars":148875683673115.78,"aud":1326027698003.64,"bdt":90891638546971.53,"bhd":336172079976.40405,"bmd":891700764656.8683,"brl":4699708880124.024,"cad":1206814439375.1382,"chf":848129590193.4374,"clp":803466973994073.1,"cny":6320107509658.4795,"czk":20979162486283.824,"dkk":6405354102759.661,"eur":861338353620.3024,"gbp":743562516624.4241,"hkd":6955399719438.295,"huf":350266250543926.2,"idr":1.3998168470621608e+16,"ils":3067968708563.893,"inr":72590227597629.94,"jpy":123855155578693.67,"krw":1172997300473948.8,"kwd":274497596588.91156,"lkr":328802223983458.4,"mmk":1878921690485388.8,"mxn":17198009722745.863,"myr":3973864457693.334,"ngn":396351951611027.4,"nok":8860110895878.242,"nzd":1429614792432.2993,"php":50462237080996.06,"pkr":200977784319637.94,"pln":4016603675343.3364,"rub":54228785569410.62,"sar":3352052980073.6323,"sek":9409936262467.938,"sgd":1219593403033.4316,"thb":31451177670212.395,"try":16620455137477.578,"twd":27545082470632.96,"uah":32883580810935.785,"vef":89285997565.0921,"vnd":2.1976613756771664e+16,"zar":15126611138967.049,"xdr":679351144561.4814,"xag":41487002266.19607,"xau":506833797.6233172,"bits":52659478006700.86,"sats":5.265947800670086e+15},"total_volume":{"btc":3178784.5123510608,"eth":42326102.49695275,"ltc":687150425.4772712,"bch":477888554.01619256,"bnb":178449984.34122005,"eos":57014269742.03237,"xrp":133141770772.5009,"xlm":598950569465.6171,"link":7213935789.919474,"dot":9913838840.705591,"yfi":8063972.913959057,"usd":53827434065.756615,"aed":197707357912.013,"ars":8986866855489.08,"aud":80045539168.20305,"bdt":5486665342154.71,"bhd":20292996470.224316,"bmd":53827434065.756615,"brl":283697491243.57025,"cad":72849241853.08417,"chf":51197264155.00141,"clp":48501209464950.12,"cny":381512704427.8628,"czk":1266405200313.7856,"dkk":386658607124.5483,"eur":51994609935.81763,"gbp":44885082444.412544,"hkd":419862059828.01294,"huf":21143789771076.484,"idr":844998143164857.9,"ils":185197646925.395,"inr":4381902365344.7925,"jpy":7476504994566.856,"krw":70807873395587.36,"kwd":16570021993.066244,"lkr":19848115795834.562,"mmk":113420933813195.2,"mxn":1038156263967.7319,"myr":239881959914.04437,"ngn":23925748847357.125,"nok":534839773572.1336,"nzd":86298564528.75388,"php":3046148267387.7983,"pkr":12132005335119.39,"pln":242461908828.816,"rub":3273515618018.7314,"sar":202346367662.1023,"sek":568029930899.3799,"sgd":73620642810.68028,"thb":1898547426933.3013,"try":1003292234923.3395,"twd":1662756352008.2532,"uah":1985014309848.3794,"vef":5389740973.004202,"vnd":1326616253869010.2,"zar":913116480318.8295,"xdr":41008968917.33732,"xag":2504359049.113173,"xau":30594975.248635393,"bits":3178784512351.0605,"sats":317878451235106.06},"market_cap_percentage":{"btc":36.500004799808664,"eth":17.188461937804522,"usdt":7.353901227277378,"bnb":5.52357355044537,"usdc":4.871681122803072,"busd":2.4925011480738757,"xrp":2.279605246638425,"doge":1.6285216885566,"ada":1.2445647848823789,"matic":0.8693436425614518},"market_cap_change_percentage_24h_usd":2.037356532779986,"updated_at":1669806962}},
    };

    jest.spyOn(httpService, 'get').mockImplementation(() => of(fakeResponse));
    let response = await service.getData();
    expect(response).toEqual({"mc":"891,700,764,657","mcChange":"2.04","volume":"53,827,434,066","coins":13148});
    // expect(httpService.get).toHaveBeenCalledWith(
    //   'https://api.coingecko.com/api/v3/global'
    // );
  });
});
